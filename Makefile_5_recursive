$ cat v1
LIBDIRS = bar foo
all : main $(LIBDIRS)
main :
	make -C $@
$(LIBDIRS) :
	make -C $@
	cp $@/$@ $@/lib$@.so
clean :
	for dir in main $(LIBDIRS); do \
		make -C $$dir $@; \
	done
.PHONY : main $(LIBDIRS) all clean

main : foo
foo : bar
$

$ cat v2
SUBDIRS = bar foo main
subdirs : $(SUBDIRS)
$(SUBDIRS) :
	make -C $@
	cp $@/$@ $@/lib$@.so
clean :
	for dir in $(SUBDIRS); do \
		make -C $$dir $@; \
	done
.PHONY : $(SUBDIRS) subdirs clean

main :
	make -C $@

main : foo
foo : bar
$
